name: Shai-Hulud Detection

on:
  schedule:
    - cron: "5 4 * * *"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  shai-hulud-detect:
    runs-on: ubuntu-latest

    steps:
      # Downloads a copy of the code in your repository by default
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: main
          path: project
          fetch-depth: 1

      # Checkout the security scanning repo we're using
      - name: Checkout scanner
        uses: actions/checkout@v6
        with:
          repository: Cobenian/shai-hulud-detect
          ref: main
          path: scanner
          fetch-depth: 1

      - name: Run scanner
        run: |
          chmod +x ./scanner/shai-hulud-detector.sh
          # Run scanner but don't fail this step; we'll handle exit code after filtering
          set +e
          ./scanner/shai-hulud-detector.sh ./project > scan_output.txt 2>&1
          scan_exit_code=$?
          set -e

          # If ignore file exists at repo root, filter output
          if [ -f .shai-hulud-ignore ]; then
            echo "Applying .shai-hulud-ignore filters"
            # Drop whole blocks containing a matching Found in: line (literal substring match)
            awk 'BEGIN{RS="\n\n"; ORS="\n\n"} \
              NR==FNR{ if ($0 ~ /^\s*#/ || $0 ~ /^\s*$/) next; pats[++n]=$0; next } \
              { if ($0 ~ /Found in:/) { drop=0; for (i=1;i<=n;i++){ if (index($0, pats[i])>0) { drop=1; break } } if (drop) next } print $0 }' \
              .shai-hulud-ignore scan_output.txt > scan_filtered.txt

            # Recompute counts from filtered output
            high_count=$(grep -c "HIGH RISK:" scan_filtered.txt || true)
            med_count=$(grep -c "MEDIUM RISK:" scan_filtered.txt || true)

            cat scan_filtered.txt
            if [ "$high_count" -gt 0 ]; then
              exit 1
            elif [ "$med_count" -gt 0 ]; then
              exit 2
            else
              exit 0
            fi
          else
            cat scan_output.txt
            exit $scan_exit_code
          fi
