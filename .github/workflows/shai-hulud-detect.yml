name: Shai-Hulud Detection

on:
  schedule:
    - cron: "5 4 * * *"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  shai-hulud-detect:
    runs-on: ubuntu-latest

    steps:
      # Downloads a copy of the code in your repository by default
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: main
          path: project
          fetch-depth: 1

      # Checkout the security scanning repo we're using
      - name: Checkout scanner
        uses: actions/checkout@v6
        with:
          repository: Cobenian/shai-hulud-detect
          ref: main
          path: scanner
          fetch-depth: 1

      - name: Run scanner
        run: |
          chmod +x ./scanner/shai-hulud-detector.sh
          # Run scanner but don't fail this step; we'll handle exit code after filtering
          set +e
          ./scanner/shai-hulud-detector.sh ./project > scan_output.txt 2>&1
          scan_exit_code=$?
          set -e

          # If ignore file exists at repo root, filter output
          if [ -f .shai-hulud-ignore ]; then
            echo "Applying .shai-hulud-ignore filters"
            # Build regex alternation of paths, including optional /project/ prefix
            patterns=$(grep -vE '^\s*#|^\s*$' .shai-hulud-ignore | sed 's#^#/project/#')
            combined=$(printf "%s\n" $(grep -vE '^\s*#|^\s*$' .shai-hulud-ignore) "$patterns" | sed 's/[^^$.*+?{}()|[\]\\]/\\&/g' | paste -sd '|' -)

            # Drop whole blocks containing a matching Found in: line
            awk -v re="$combined" 'BEGIN{RS="\n\n"; ORS="\n\n"} { if ($0 ~ /Found in:/ && $0 ~ re) next; print $0 }' scan_output.txt > scan_filtered.txt

            # Recompute counts from filtered output
            high_count=$(grep -c "HIGH RISK:" scan_filtered.txt || true)
            med_count=$(grep -c "MEDIUM RISK:" scan_filtered.txt || true)

            cat scan_filtered.txt
            if [ "$high_count" -gt 0 ]; then
              exit 1
            elif [ "$med_count" -gt 0 ]; then
              exit 2
            else
              exit 0
            fi
          else
            cat scan_output.txt
            exit $scan_exit_code
          fi
