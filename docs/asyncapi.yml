asyncapi: 3.0.0
info:
  title: FCP Farming Data Model (FDM)
  version: 1.1.0
  description: |
    The FDM service consumes events from FCP services via AWS SQS to build
    a farming data model to support data exchange via the Data Access Layer (DAL).
    
    Events from various sources are consumed from the `fcp_fdm_events` SQS queue.
  license:
    name: Open Government Licence v3.0
    url: https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3

defaultContentType: application/json

servers:
  local:
    host: localhost:4566
    protocol: sqs
    description: LocalStack SQS for local development
    bindings:
      sqs:
        region: eu-west-2
        queueName: fcp_fdm_events
        deadLetterQueue:
          name: fcp_fdm_events-deadletter
          maxReceiveCount: 3
  dev:
    host: sqs.eu-west-2.amazonaws.com/332499610595
    protocol: sqs
    description: CDP Development environment
    bindings:
      sqs:
        region: eu-west-2
        queueName: fcp_fdm_events
        deadLetterQueue:
          name: fcp_fdm_events-deadletter
          maxReceiveCount: 3
  test:
    host: sqs.eu-west-2.amazonaws.com/756547862786
    protocol: sqs
    description: CDP Test environment
    bindings:
      sqs:
        region: eu-west-2
        queueName: fcp_fdm_events
        deadLetterQueue:
          name: fcp_fdm_events-deadletter
          maxReceiveCount: 3
  perf-test:
    host: sqs.eu-west-2.amazonaws.com/120185944470
    protocol: sqs
    description: CDP Performance Test environment
    bindings:
      sqs:
        region: eu-west-2
        queueName: fcp_fdm_events
        deadLetterQueue:
          name: fcp_fdm_events-deadletter
          maxReceiveCount: 3
  ext-test:
    host: sqs.eu-west-2.amazonaws.com/711387132227
    protocol: sqs
    description: CDP External Test environment
    bindings:
      sqs:
        region: eu-west-2
        queueName: fcp_fdm_events
        deadLetterQueue:
          name: fcp_fdm_events-deadletter
          maxReceiveCount: 3
  prod:
    host: sqs.eu-west-2.amazonaws.com/409408189387
    protocol: sqs
    description: CDP Production environment
    bindings:
      sqs:
        region: eu-west-2
        queueName: fcp_fdm_events
        deadLetterQueue:
          name: fcp_fdm_events-deadletter
          maxReceiveCount: 3

channels:
  eventQueue:
    address: fcp_fdm_events
    description: SQS queue for consuming events from all FCP services
    messages:
      commsEvent:
        $ref: '#/components/messages/CommsEvent'

operations:
  receiveEvents:
    action: receive
    channel:
      $ref: '#/channels/eventQueue'
    summary: Receive and process events from FCP services
    description: |
      Consumes events from the SQS queue. Events are validated, persisted and aggregated.
    messages:
      - $ref: '#/channels/eventQueue/messages/commsEvent'

components:
  messages:
    CommsEvent:
      name: CommsEvent
      title: Comms Event
      summary: CloudEvent for comms lifecycle events from fcp-sfd-comms
      description: |
        Comms events from the Single Front Door Comms service.
        
        These events follow the CloudEvents 1.0 specification and track the lifecycle
        of communications including received, sending, delivered, retry, failure,
        and retry.expired states.
        
        **Processing:**
        - Events are validated for required CloudEvents fields and comms-specific data
        - Aggregated by `correlationId` to track comms lifecycle across multiple events
        
        **Event Types:** All events with type prefix `uk.gov.fcp.sfd.notification.*`
      contentType: application/json
      payload:
        $ref: '#/components/schemas/CommsEventPayload'
      examples:
        - name: receivedEvent
          summary: Message received event
          payload:
            specversion: "1.0"
            type: "uk.gov.fcp.sfd.notification.received"
            source: "fcp-sfd-comms"
            id: "a1b2c3d4-e5f6-4a5b-8c9d-0e1f2a3b4c5d"
            time: "2026-01-13T10:30:00Z"
            subject: "Message notification"
            datacontenttype: "application/json"
            data:
              correlationId: "f47ac10b-58cc-4372-a567-0e02b2c3d479"
              recipient: "farmer@example.com"
              crn: 1234567890
              sbi: 123456789
              content:
                subject: "Your application update"
                body: "Your application has been received"

  schemas:
    CommsEventPayload:
      description: CloudEvent envelope for comms events
      type: object
      required:
        - specversion
        - type
        - source
        - id
        - time
        - data
      properties:
        specversion:
          type: string
          const: "1.0"
          description: CloudEvents specification version
        type:
          type: string
          pattern: "^uk\\.gov\\.fcp\\.sfd\\.notification\\."
          description: Event type identifier
          examples:
            - "uk.gov.fcp.sfd.notification.received"
            - "uk.gov.fcp.sfd.notification.sending"
            - "uk.gov.fcp.sfd.notification.delivered"
            - "uk.gov.fcp.sfd.notification.failure.validation"
            - "uk.gov.fcp.sfd.notification.retry"
            - "uk.gov.fcp.sfd.notification.retry.expired"
        source:
          type: string
          description: Source service identifier
          examples:
            - "fcp-sfd-comms"
        id:
          type: string
          format: uuid
          description: Unique event identifier
        time:
          type: string
          format: date-time
          description: Event timestamp (ISO 8601)
        subject:
          type: string
          description: Event subject/context
        datacontenttype:
          type: string
          description: Content type of the data payload
          default: "application/json"
        data:
          $ref: '#/components/schemas/CommsEventData'

    CommsEventData:
      description: Comms event data - only correlationId and recipient are required
      type: object
      required:
        - correlationId
        - recipient
      properties:
        correlationId:
          type: string
          format: uuid
          description: Correlation ID for aggregating related comms events
        recipient:
          type: string
          description: Message recipient (email, phone, or postal address)
        crn:
          type: integer
          description: Customer Reference Number
          minimum: 1050000000
          maximum: 9999999999
        sbi:
          type: integer
          description: Single Business Identifier
          minimum: 105000000
          maximum: 999999999
        content:
          type: object
          description: Message content details
          properties:
            subject:
              type: string
              description: Message subject
            body:
              type: string
              description: Message body
