name: Shai-Hulud Detection

on:
  schedule:
    - cron: "5 4 * * *"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  shai-hulud-detect:
    runs-on: ubuntu-latest

    steps:
      # Downloads a copy of the code in your repository by default
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: main
          path: project
          fetch-depth: 1

      # Checkout the security scanning repo we're using
      - name: Checkout scanner
        uses: actions/checkout@v6
        with:
          repository: Cobenian/shai-hulud-detect
          ref: main
          path: scanner
          fetch-depth: 1

      - name: Run scanner
        run: |
          chmod +x ./scanner/shai-hulud-detector.sh
          
          # Run scanner and capture output
          set +e
          ./scanner/shai-hulud-detector.sh ./project > scan_output.txt 2>&1
          scan_exit_code=$?
          set -e
          
          # Filter out ignored paths if .shai-hulud-ignore exists
          if [ -f project/.shai-hulud-ignore ]; then
            echo "Filtering scan results based on .shai-hulud-ignore..."
            
            # Read ignore patterns
            ignore_patterns=()
            while IFS= read -r pattern || [ -n "$pattern" ]; do
              # Skip comments and empty lines
              [[ "$pattern" =~ ^#.*$ || -z "$pattern" ]] && continue
              ignore_patterns+=("$pattern")
            done < project/.shai-hulud-ignore
            
            # Filter the output
            filtered_output=$(cat scan_output.txt)
            for pattern in "${ignore_patterns[@]}"; do
              # Remove lines containing the ignored path
              filtered_output=$(echo "$filtered_output" | grep -v "$pattern" || true)
            done
            
            # Check if any real issues remain after filtering
            if echo "$filtered_output" | grep -q "High Risk Issues: [1-9]"; then
              echo "$filtered_output"
              exit 1
            elif echo "$filtered_output" | grep -q "Medium Risk Issues: [1-9]"; then
              echo "$filtered_output"
              exit 2
            else
              echo "$filtered_output"
              exit 0
            fi
          else
            # No ignore file, use original output and exit code
            cat scan_output.txt
            exit $scan_exit_code
          fi
