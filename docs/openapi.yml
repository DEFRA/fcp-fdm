openapi: 3.1.0
info:
  title: FCP Farming Data Model (FDM) - REST API
  version: 1.0.0
  description: |
    The Farming Data Model (FDM) REST API provides access to aggregated farming and 
    countryside programme data collected from various FCP services.
  license:
    name: Open Government Licence v3.0
    url: https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3

servers:
  - url: http://localhost:3000
    description: Local development server

security:
  - BearerAuth: []

paths:
  /health:
    get:
      tags:
        - Health
      summary: Service health check
      description: |
        Returns the health status of the FDM service. This endpoint can be used
        for monitoring, load balancer health checks, and service discovery.
      operationId: getHealth
      security: []
      responses:
        '200':
          description: Service is healthy and operational
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              examples:
                success:
                  summary: Healthy service response
                  value:
                    message: "success"
        '500':
          description: Service is unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                error:
                  summary: Service error response
                  value:
                    statusCode: 500
                    error: "Internal Server Error"
                    message: "Service temporarily unavailable"

  /documentation:
    get:
      tags:
        - Documentation
      summary: API documentation
      description: |
        Interactive API documentation powered by Swagger UI. Available only in
        development mode for exploring the API endpoints and schemas.
      operationId: getDocumentation
      security: []
      responses:
        '200':
          description: Swagger UI documentation page
          content:
            text/html:
              schema:
                type: string
        '404':
          description: Documentation not available (production mode)

  /api/v1/messages:
    get:
      tags:
        - Messages
      summary: Get all messages
      description: |
        Retrieve all messages with optional filtering by CRN (Customer Reference Number) 
        or SBI (Single Business Identifier). Content and event history can be optionally included.
        
        **Authentication Required**: This endpoint requires a valid JWT Bearer token from Microsoft Entra ID 
        with appropriate security group membership.
      operationId: getMessages
      security:
        - BearerAuth: []
      parameters:
        - name: Authorization
          in: header
          description: Bearer token for authentication
          required: true
          schema:
            type: string
            example: "Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik..."
          style: simple
        - name: crn
          in: query
          description: Filter messages by Customer Reference Number
          required: false
          schema:
            type: integer
            example: 1234567890
        - name: sbi
          in: query
          description: Filter messages by Single Business Identifier
          required: false
          schema:
            type: integer
            example: 987654321
        - name: includeContent
          in: query
          description: Whether to include the recipient, subject and body content
          required: false
          schema:
            type: boolean
            default: false
        - name: includeEvents
          in: query
          description: Whether to include the event history
          required: false
          schema:
            type: boolean
            default: false
        - name: page
          in: query
          description: Page number for paginated results (1-based)
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
            example: 2
        - name: pageSize
          in: query
          description: Number of items per page
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
            example: 10
      responses:
        '200':
          description: Successfully retrieved messages
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedMessagesResponse'
              examples:
                basic:
                  summary: Basic paginated messages response
                  value:
                    data:
                      messages:
                        - correlationId: "550e8400-e29b-41d4-a716-446655440000"
                          crn: 1234567890
                          sbi: 987654321
                          status: "delivered"
                          created: "2024-01-01T10:00:00.000Z"
                          lastUpdated: "2024-01-01T10:05:00.000Z"
                    links:
                      self: "/api/v1/messages?page=1&pageSize=20"
                      next: "/api/v1/messages?page=2&pageSize=20"
                      prev: null
                    meta:
                      page: 1
                      pageSize: 20
                      totalPages: 5
                      totalItems: 100
                withContent:
                  summary: Paginated messages with content included
                  value:
                    data:
                      messages:
                        - correlationId: "550e8400-e29b-41d4-a716-446655440000"
                          crn: 1234567890
                          sbi: 987654321
                          recipient: "user@example.com"
                          subject: "Application Status Update"
                          body: "Your application has been processed successfully."
                          status: "delivered"
                          created: "2024-01-01T10:00:00.000Z"
                          lastUpdated: "2024-01-01T10:05:00.000Z"
                    links:
                      self: "/api/v1/messages?page=1&pageSize=20"
                      next: "/api/v1/messages?page=2&pageSize=20"
                      prev: null
                    meta:
                      page: 1
                      pageSize: 20
                      totalPages: 5
                      totalItems: 100
        '401':
          description: Unauthorized - Invalid or missing JWT token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                unauthorized:
                  summary: Missing or invalid token
                  value:
                    statusCode: 401
                    error: "Unauthorized"
                    message: "Missing or invalid authentication token"
        '403':
          description: Forbidden - Valid token but insufficient permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                forbidden:
                  summary: Insufficient permissions
                  value:
                    statusCode: 403
                    error: "Forbidden"
                    message: "User does not have required security group membership"

  /api/v1/messages/{correlationId}:
    get:
      tags:
        - Messages
      summary: Get message by correlation ID
      description: |
        Retrieve a specific message by its correlation ID. Content and event history 
        can be optionally included in the response.
        
        **Authentication Required**: This endpoint requires a valid JWT Bearer token from Microsoft Entra ID 
        with appropriate security group membership.
      operationId: getMessageByCorrelationId
      security:
        - BearerAuth: []
      parameters:
        - name: Authorization
          in: header
          description: Bearer token for authentication
          required: true
          schema:
            type: string
            example: "Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik..."
          style: simple
        - name: correlationId
          in: path
          description: The correlation ID of the message (UUID format)
          required: true
          schema:
            type: string
            format: uuid
            example: "550e8400-e29b-41d4-a716-446655440000"
        - name: includeContent
          in: query
          description: Whether to include the recipient, subject and body content
          required: false
          schema:
            type: boolean
            default: false
        - name: includeEvents
          in: query
          description: Whether to include the event history
          required: false
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Successfully retrieved message
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
              examples:
                basic:
                  summary: Basic message without content or events
                  value:
                    data:
                      message:
                        correlationId: "550e8400-e29b-41d4-a716-446655440000"
                        crn: 1234567890
                        sbi: 987654321
                        status: "delivered"
                        created: "2024-01-01T10:00:00.000Z"
                        lastUpdated: "2024-01-01T10:05:00.000Z"
                withEvents:
                  summary: Message with event history
                  value:
                    data:
                      message:
                        correlationId: "550e8400-e29b-41d4-a716-446655440000"
                        crn: 1234567890
                        sbi: 987654321
                        status: "delivered"
                        created: "2024-01-01T10:00:00.000Z"
                        lastUpdated: "2024-01-01T10:05:00.000Z"
                        events:
                          - type: "uk.gov.fcp.sfd.notification.received"
                          - type: "uk.gov.fcp.sfd.notification.sending"
                          - type: "uk.gov.fcp.sfd.notification.delivered"
        '401':
          description: Unauthorized - Invalid or missing JWT token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                unauthorized:
                  summary: Missing or invalid token
                  value:
                    statusCode: 401
                    error: "Unauthorized"
                    message: "Missing or invalid authentication token"
        '403':
          description: Forbidden - Valid token but insufficient permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                forbidden:
                  summary: Insufficient permissions
                  value:
                    statusCode: 403
                    error: "Forbidden"
                    message: "User does not have required security group membership"
        '404':
          description: Message not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                notFound:
                  summary: Message not found
                  value:
                    error: "Message not found with correlationId: 550e8400-e29b-41d4-a716-446655440000"

tags:
  - name: Health
    description: Service health and monitoring endpoints
  - name: Documentation
    description: API documentation and exploration
  - name: Messages
    description: Message data access and querying endpoints

components:
  schemas:
    HealthResponse:
      type: object
      properties:
        message:
          type: string
          description: Health status message
          example: "success"
      required:
        - message
    
    ErrorResponse:
      type: object
      properties:
        statusCode:
          type: integer
          description: HTTP status code
          example: 500
        error:
          type: string
          description: Error type
          example: "Internal Server Error"
        message:
          type: string
          description: Error message
          example: "Service temporarily unavailable"
      required:
        - statusCode
        - error
        - message

    Message:
      type: object
      properties:
        correlationId:
          type: string
          format: uuid
          description: Unique correlation identifier for the message
          example: "550e8400-e29b-41d4-a716-446655440000"
        crn:
          type: integer
          description: Customer Reference Number
          example: 1234567890
        sbi:
          type: integer
          description: Single Business Identifier
          example: 987654321
        status:
          type: string
          description: Current status of the message
          enum:
            - "received"
            - "failure.validation"
            - "sending"
            - "delivered"
            - "failure.provider"
            - "failure.internal"
            - "retry"
            - "retry.expired"
          example: "delivered"
        created:
          type: string
          format: date-time
          description: When the message was first created
          example: "2024-01-01T10:00:00.000Z"
        lastUpdated:
          type: string
          format: date-time
          description: When the message was last updated
          example: "2024-01-01T10:05:00.000Z"
        recipient:
          type: string
          format: email
          description: Email address of the message recipient (included when includeContent=true)
          example: "user@example.com"
        subject:
          type: string
          description: Subject line of the message (included when includeContent=true)
          example: "Application Status Update"
        body:
          type: string
          description: Body content of the message (included when includeContent=true)
          example: "Your application has been processed successfully."
        events:
          type: array
          description: Event history for this message (included when includeEvents=true)
          items:
            $ref: '#/components/schemas/Event'
      required:
        - correlationId
        - crn
        - sbi
        - status
        - created
        - lastUpdated

    Event:
      type: object
      properties:
        type:
          type: string
          description: CloudEvent type indicating the event category
          example: "uk.gov.fcp.sfd.notification.received"
      required:
        - type

    PaginatedMessagesResponse:
      type: object
      properties:
        data:
          type: object
          properties:
            messages:
              type: array
              items:
                $ref: '#/components/schemas/Message'
          required:
            - messages
        links:
          type: object
          description: Pagination links for navigation
          properties:
            self:
              type: string
              format: uri
              description: Link to the current page
            next:
              type:
                - string
                - 'null'
              format: uri
              description: Link to the next page, if available
            prev:
              type:
                - string
                - 'null'
              format: uri
              description: Link to the previous page, if available
          required:
            - self
        meta:
          type: object
          description: Pagination metadata
          properties:
            page:
              type: integer
              description: Current page number
            pageSize:
              type: integer
              description: Number of items per page
            pages:
              type: integer
              description: Total number of pages
            total:
              type: integer
              description: Total number of items
          required:
            - page
            - pageSize
            - pages
            - total
      required:
        - data
        - links
        - meta

    MessageResponse:
      type: object
      properties:
        data:
          type: object
          properties:
            message:
              $ref: '#/components/schemas/Message'
          required:
            - message
      required:
        - data

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT Bearer token authentication using Microsoft Entra ID.
        
        **Token Requirements:**
        - Valid JWT token from Microsoft Entra ID
        - Token must include security groups in claims
        - User must be member of authorized security groups
        
        **Header Format:** `Authorization: Bearer <jwt-token>`
        
        **Example Usage:**
        ```
        Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik...
        ```
